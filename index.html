<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Territory Mapper</title>

    <!-- Azure Maps CSS -->
    <link rel="stylesheet" href="https://atlas.microsoft.com/sdk/javascript/mapcontrol/2/atlas.min.css" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <h1>Sales Territory Mapper</h1>
            <div class="header-actions">
                <button id="saveToFirebase" class="btn btn-primary">Save to Firebase</button>
                <button id="loadFromFirebase" class="btn btn-secondary">Load from Firebase</button>
            </div>
        </header>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Sidebar -->
            <aside class="sidebar">
                <!-- CSV Upload Section -->
                <section class="panel">
                    <h2>Upload Data</h2>
                    <div class="upload-area">
                        <input type="file" id="csvFileInput" accept=".csv" />
                        <button id="uploadBtn" class="btn btn-primary">Upload CSV</button>
                    </div>
                    <div class="upload-info">
                        <small>Supported columns: WKT, Latitude, Longitude, Name, Description, and custom attributes</small>
                    </div>
                </section>

                <!-- Address Search Section -->
                <section class="panel">
                    <h2>Address Search</h2>
                    <div class="search-area">
                        <input type="text" id="addressSearch" placeholder="Search for an address..." />
                        <button id="searchBtn" class="btn btn-primary">Search</button>
                    </div>
                </section>

                <!-- Drawing Tools Section -->
                <section class="panel">
                    <h2>Drawing Tools</h2>
                    <div class="drawing-controls">
                        <button id="drawPointBtn" class="btn btn-small">üìç Draw Point</button>
                        <button id="drawPolygonBtn" class="btn btn-small">‚¨ü Draw Polygon</button>
                        <button id="deleteDrawingBtn" class="btn btn-small btn-danger">üóëÔ∏è Delete Selected</button>
                    </div>
                    <div class="drawing-info">
                        <small id="drawingStatus">Select a tool to start drawing</small>
                    </div>
                </section>

                <!-- Layer Management Section -->
                <section class="panel">
                    <h2>Layers</h2>
                    <div class="layer-controls">
                        <input type="text" id="newLayerName" placeholder="New layer name..." />
                        <button id="createLayerBtn" class="btn btn-small">Create Layer</button>
                    </div>
                    <div id="layerList" class="layer-list">
                        <!-- Layers will be dynamically added here -->
                    </div>
                </section>

                <!-- Filter & Sort Section -->
                <section class="panel">
                    <h2>Filter & Sort</h2>
                    <div class="filter-controls">
                        <select id="filterColumn" class="form-select">
                            <option value="">Select column...</option>
                        </select>
                        <input type="text" id="filterValue" placeholder="Filter value..." />
                        <button id="applyFilterBtn" class="btn btn-small">Apply Filter</button>
                        <button id="clearFilterBtn" class="btn btn-small btn-secondary">Clear</button>
                    </div>
                    <div class="sort-controls">
                        <select id="sortColumn" class="form-select">
                            <option value="">Sort by...</option>
                        </select>
                        <button id="sortAscBtn" class="btn btn-small">‚Üë Asc</button>
                        <button id="sortDescBtn" class="btn btn-small">‚Üì Desc</button>
                    </div>
                </section>

                <!-- Feature Info Section -->
                <section class="panel">
                    <h2>Selected Feature</h2>
                    <div id="featureInfo" class="feature-info">
                        <p class="empty-state">Click on a feature to see details</p>
                    </div>
                </section>
            </aside>

            <!-- Map Container -->
            <main class="map-container">
                <div id="azureMap"></div>

                <!-- Map Controls Overlay -->
                <div class="map-controls">
                    <button id="zoomIn" class="map-btn" title="Zoom In">+</button>
                    <button id="zoomOut" class="map-btn" title="Zoom Out">-</button>
                    <button id="resetView" class="map-btn" title="Reset View">‚åÇ</button>
                </div>

                <!-- Legend -->
                <div id="mapLegend" class="map-legend">
                    <h3>Legend</h3>
                    <div id="legendContent"></div>
                </div>
            </main>
        </div>

        <!-- Edit Modal -->
        <div id="editModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Edit Feature</h2>
                    <span class="close" data-modal="editModal">&times;</span>
                </div>
                <div class="modal-body">
                    <form id="editForm">
                        <div id="editFormFields">
                            <!-- Form fields will be dynamically generated -->
                        </div>
                        <div class="modal-actions">
                            <button type="submit" class="btn btn-primary">Save Changes</button>
                            <button type="button" class="btn btn-secondary" id="cancelEdit">Cancel</button>
                            <button type="button" class="btn btn-danger" id="deleteFeature">Delete Feature</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Column Mapping Modal -->
        <div id="columnMapModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Map Address Columns</h2>
                    <span class="close" data-modal="columnMapModal">&times;</span>
                </div>
                <div class="modal-body">
                    <p>Your CSV doesn't have WKT or Lat/Long columns. Please map address columns for geocoding:</p>
                    <form id="columnMapForm">
                        <div class="form-group">
                            <label for="street1Column">Street 1 / Address:</label>
                            <select id="street1Column" class="form-select" required>
                                <option value="">-- Select Column --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="street2Column">Street 2 (Optional):</label>
                            <select id="street2Column" class="form-select">
                                <option value="">-- None --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="cityColumn">City:</label>
                            <select id="cityColumn" class="form-select" required>
                                <option value="">-- Select Column --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="stateColumn">State (Optional):</label>
                            <select id="stateColumn" class="form-select">
                                <option value="">-- None --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="zipColumn">Zip Code:</label>
                            <select id="zipColumn" class="form-select" required>
                                <option value="">-- Select Column --</option>
                            </select>
                        </div>
                        <div class="modal-actions">
                            <button type="submit" class="btn btn-primary">Geocode Addresses</button>
                            <button type="button" class="btn btn-secondary" id="cancelMapping">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Geocoding Progress Modal -->
        <div id="geocodingModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Geocoding Addresses</h2>
                </div>
                <div class="modal-body">
                    <div class="progress-container">
                        <div class="progress-bar">
                            <div id="geocodingProgress" class="progress-fill"></div>
                        </div>
                        <p id="geocodingStatus">Processing addresses...</p>
                        <p id="geocodingStats"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
        <p>Loading...</p>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <!-- Azure Maps SDK -->
    <script src="https://atlas.microsoft.com/sdk/javascript/mapcontrol/2/atlas.min.js"></script>

    <!-- Azure Maps Drawing Tools -->
    <link rel="stylesheet" href="https://atlas.microsoft.com/sdk/javascript/drawing/0/atlas-drawing.min.css" />
    <script src="https://atlas.microsoft.com/sdk/javascript/drawing/0/atlas-drawing.min.js"></script>

    <!-- PapaParse for CSV parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <!-- Wellknown for WKT parsing -->
    <script src="https://unpkg.com/wellknown@0.5.0/wellknown.js"></script>

    <!-- Application JavaScript -->
    <script src="js/firebase-config.js"></script>
    <script src="js/geocoding-service.js"></script>
    <script src="js/map-manager.js"></script>
    <script src="js/layer-manager.js"></script>
    <script src="js/csv-parser.js"></script>
    <script src="js/app.js"></script>
</body>
</html>
