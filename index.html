<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Territory Mapper</title>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <h1>Sales Territory Mapper</h1>
            <div class="header-actions">
                <button id="saveToFirebase" class="btn btn-primary">Save to Firebase</button>
                <button id="loadFromFirebase" class="btn btn-secondary">Load from Firebase</button>
            </div>
        </header>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Sidebar -->
            <aside class="sidebar">
                <!-- Quick Actions -->
                <section class="panel compact">
                    <div class="quick-actions">
                        <button id="showUploadBtn" class="btn btn-small" title="Import CSV/Excel files">
                            <span>üì§</span>Upload
                        </button>
                        <button id="showSearchBtn" class="btn btn-small" title="Search for an address">
                            <span>üîç</span>Search
                        </button>
                        <button id="showDrawToolsBtn" class="btn btn-small" title="Draw points or polygons">
                            <span>‚úèÔ∏è</span>Draw
                        </button>
                        <button id="showFilterBtn" class="btn btn-small" title="Filter and sort layers">
                            <span>‚öôÔ∏è</span>Filter
                        </button>
                        <button id="showPluginsBtn" class="btn btn-small" title="Manage plugins">
                            <span>üîå</span>Plugins
                        </button>
                    </div>
                </section>

                <!-- Layer Groups -->
                <section class="panel">
                    <div class="panel-header">
                        <h2>Layer Groups</h2>
                        <button id="addGroupBtn" class="icon-btn" title="Add group">+</button>
                    </div>
                    <div id="layerGroupList" class="layer-group-list">
                        <!-- Layer groups will be dynamically added here -->
                    </div>
                </section>

                <!-- Layers Section -->
                <section class="panel">
                    <div class="panel-header">
                        <h2>Layers</h2>
                        <button id="addLayerBtn" class="icon-btn" title="Add layer">+</button>
                    </div>
                    <div id="layerList" class="layer-list">
                        <!-- Layers will be dynamically added here -->
                    </div>
                </section>

                <!-- Feature Info Section -->
                <section class="panel">
                    <h2>Selected Feature</h2>
                    <div id="featureInfo" class="feature-info">
                        <p class="empty-state">Click on a feature to see details</p>
                    </div>
                </section>
            </aside>

            <!-- Map Container -->
            <main class="map-container">
                <div id="googleMap"></div>

                <!-- Map Controls Overlay -->
                <div class="map-controls">
                    <button id="zoomIn" class="map-btn" title="Zoom In">+</button>
                    <button id="zoomOut" class="map-btn" title="Zoom Out">-</button>
                    <button id="resetView" class="map-btn" title="Reset View">‚åÇ</button>
                </div>

                <!-- Polygon Edit Controls -->
                <div id="polygonEditControls" class="polygon-edit-controls" style="display: none;">
                    <span class="edit-label">Editing Polygon</span>
                    <button id="savePolygonEdit" class="btn btn-primary btn-small">Save</button>
                    <button id="cancelPolygonEdit" class="btn btn-secondary btn-small">Cancel</button>
                </div>

                <!-- Legend -->
                <div id="mapLegend" class="map-legend">
                    <h3>Legend</h3>
                    <div id="legendContent"></div>
                </div>
            </main>
        </div>

        <!-- Edit Modal -->
        <div id="editModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Edit Feature</h2>
                    <span class="close" data-modal="editModal">&times;</span>
                </div>
                <div class="modal-body">
                    <form id="editForm">
                        <div id="editFormFields">
                            <!-- Form fields will be dynamically generated -->
                        </div>
                        <div class="modal-actions">
                            <button type="submit" class="btn btn-primary">Save Changes</button>
                            <button type="button" class="btn btn-secondary" id="cancelEdit">Cancel</button>
                            <button type="button" class="btn btn-danger" id="deleteFeature">Delete Feature</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Column Mapping Modal -->
        <div id="columnMapModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Map Address Columns</h2>
                    <span class="close" data-modal="columnMapModal">&times;</span>
                </div>
                <div class="modal-body">
                    <p>Your CSV doesn't have WKT or Lat/Long columns. Please map address columns for geocoding:</p>

                    <!-- Template Controls -->
                    <div class="template-controls">
                        <div class="form-group">
                            <label for="templateSelect">Load Template:</label>
                            <div style="display: flex; gap: 0.5rem;">
                                <select id="templateSelect" class="form-select" style="flex: 1;">
                                    <option value="">-- No Template --</option>
                                </select>
                                <button type="button" id="loadTemplateBtn" class="btn btn-small btn-secondary">Load</button>
                                <button type="button" id="deleteTemplateBtn" class="btn btn-small btn-danger" style="display: none;">Delete</button>
                            </div>
                        </div>
                    </div>

                    <hr style="margin: 1rem 0;">

                    <form id="columnMapForm">
                        <div class="form-group">
                            <label for="street1Column">Street 1 / Address:</label>
                            <select id="street1Column" class="form-select" required>
                                <option value="">-- Select Column --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="street2Column">Street 2 (Optional):</label>
                            <select id="street2Column" class="form-select">
                                <option value="">-- None --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="cityColumn">City:</label>
                            <select id="cityColumn" class="form-select" required>
                                <option value="">-- Select Column --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="stateColumn">State (Optional):</label>
                            <select id="stateColumn" class="form-select">
                                <option value="">-- None --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="zipColumn">Zip Code:</label>
                            <select id="zipColumn" class="form-select" required>
                                <option value="">-- Select Column --</option>
                            </select>
                        </div>
                        <div class="modal-actions">
                            <button type="submit" class="btn btn-primary">Geocode Addresses</button>
                            <button type="button" class="btn btn-secondary" id="saveTemplateBtn">Save as Template</button>
                            <button type="button" class="btn btn-secondary" id="cancelMapping">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Geocoding Progress Modal -->
        <div id="geocodingModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Geocoding Addresses</h2>
                </div>
                <div class="modal-body">
                    <div class="progress-container">
                        <div class="progress-bar">
                            <div id="geocodingProgress" class="progress-fill"></div>
                        </div>
                        <p id="geocodingStatus">Processing addresses...</p>
                        <p id="geocodingStats"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Upload Modal -->
        <div id="uploadModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Import Data</h2>
                    <span class="close" data-modal="uploadModal">&times;</span>
                </div>
                <div class="modal-body">
                    <!-- Import Tabs -->
                    <div class="import-tabs">
                        <button class="import-tab active" data-tab="file">üìÅ Upload Files</button>
                        <button class="import-tab" data-tab="paste">üìã Copy/Paste</button>
                    </div>

                    <!-- File Upload Tab -->
                    <div id="fileTab" class="import-tab-content active">
                        <div class="upload-area">
                            <input type="file" id="csvFileInput" accept=".csv,.xlsx,.xls" multiple />
                            <button id="uploadBtn" class="btn btn-primary">Upload Files</button>
                        </div>
                        <div class="upload-info">
                            <small>Supported: CSV and Excel files (.csv, .xlsx, .xls). Select multiple files to create separate layers.</small>
                            <small style="display: block; margin-top: 0.25rem;">Data: WKT polygons, Lat/Long coordinates, or address columns (Street, City, Zip)</small>
                        </div>
                    </div>

                    <!-- Copy/Paste Tab -->
                    <div id="pasteTab" class="import-tab-content">
                        <div class="paste-area">
                            <label for="pasteInput">Copy data from Excel or CSV and paste below:</label>
                            <textarea id="pasteInput" placeholder="Paste your data here (tab-separated or comma-separated)..." rows="10"></textarea>
                            <button id="importPasteBtn" class="btn btn-primary">Import Pasted Data</button>
                        </div>
                        <div class="upload-info">
                            <small>Copy cells directly from Excel or Google Sheets and paste them here.</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search Modal -->
        <div id="searchModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Address Search</h2>
                    <span class="close" data-modal="searchModal">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="search-area-modal">
                        <input type="text" id="addressSearch" placeholder="Enter address to search..." />
                        <button id="searchBtn" class="btn btn-primary">Search</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Drawing Tools Modal -->
        <div id="drawToolsModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Drawing Tools</h2>
                    <span class="close" data-modal="drawToolsModal">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="drawing-controls">
                        <button id="drawPointBtn" class="btn btn-primary">üìç Draw Point</button>
                        <button id="drawPolygonBtn" class="btn btn-primary">‚¨ü Draw Polygon</button>
                        <button id="deleteDrawingBtn" class="btn btn-danger">üóëÔ∏è Delete Selected</button>
                    </div>
                    <div class="drawing-info">
                        <small id="drawingStatus">Select a tool to start drawing</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filter & Sort Modal -->
        <div id="filterModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Filter & Sort</h2>
                    <span class="close" data-modal="filterModal">&times;</span>
                </div>
                <div class="modal-body">
                    <h3>Filter</h3>
                    <div class="filter-controls">
                        <select id="filterColumn" class="form-select">
                            <option value="">Select column...</option>
                        </select>
                        <input type="text" id="filterValue" placeholder="Filter value..." />
                        <button id="applyFilterBtn" class="btn btn-primary">Apply Filter</button>
                        <button id="clearFilterBtn" class="btn btn-secondary">Clear Filter</button>
                    </div>
                    <hr style="margin: 1.5rem 0;">
                    <h3>Sort</h3>
                    <div class="sort-controls">
                        <select id="sortColumn" class="form-select">
                            <option value="">Sort by...</option>
                        </select>
                        <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                            <button id="sortAscBtn" class="btn btn-primary">‚Üë Ascending</button>
                            <button id="sortDescBtn" class="btn btn-primary">‚Üì Descending</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Layer Actions Menu -->
        <div id="layerActionsMenu" class="context-menu">
            <button class="context-menu-item" data-action="add">‚ûï Add Feature</button>
            <button class="context-menu-item" data-action="rename">‚úèÔ∏è Rename Layer</button>
            <button class="context-menu-item" data-action="zoom">üîç Zoom to Layer</button>
            <button class="context-menu-item" data-action="style">üé® Style Options</button>
            <button class="context-menu-item" data-action="export">üì• Export to CSV</button>
            <button class="context-menu-item" data-action="group">üìÅ Move to Group</button>
            <button class="context-menu-item" data-action="delete">üóëÔ∏è Delete Layer</button>
        </div>

        <!-- Rename Layer Modal -->
        <div id="renameLayerModal" class="modal">
            <div class="modal-content modal-small">
                <div class="modal-header">
                    <h2>Rename Layer</h2>
                    <span class="close" data-modal="renameLayerModal">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="newLayerName">New Name:</label>
                        <input type="text" id="newLayerName" class="form-input" placeholder="Enter new layer name..." />
                    </div>
                    <div class="modal-actions">
                        <button id="confirmRenameBtn" class="btn btn-primary">Rename</button>
                        <button id="cancelRenameBtn" class="btn btn-secondary">Cancel</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Move Feature to Layer Modal -->
        <div id="moveFeatureModal" class="modal">
            <div class="modal-content modal-small">
                <div class="modal-header">
                    <h2>Move Feature to Layer</h2>
                    <span class="close" data-modal="moveFeatureModal">&times;</span>
                </div>
                <div class="modal-body">
                    <p id="moveFeatureInfo" class="text-muted">Select target layer:</p>
                    <div class="form-group">
                        <label for="targetLayerSelect">Target Layer:</label>
                        <select id="targetLayerSelect" class="form-select">
                            <!-- Options will be populated dynamically -->
                        </select>
                    </div>
                    <div class="modal-actions">
                        <button id="confirmMoveBtn" class="btn btn-primary">Move</button>
                        <button id="cancelMoveBtn" class="btn btn-secondary">Cancel</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Style Options Modal -->
        <div id="styleModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Style Options</h2>
                    <span class="close" data-modal="styleModal">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>Style Type:</label>
                        <select id="styleType" class="form-select">
                            <option value="single">Single Color</option>
                            <option value="tier">Tier Map (by Tier column)</option>
                            <option value="zone">Zone Map (unique colors per zone)</option>
                            <option value="bdm">BDM Map (by BDM column)</option>
                            <option value="custom">Custom Property</option>
                        </select>
                    </div>
                    <div class="form-group" id="customPropertyGroup" style="display: none;">
                        <label>Property Column:</label>
                        <select id="customProperty" class="form-select">
                            <option value="">Select property...</option>
                        </select>
                    </div>
                    <div class="form-group" id="singleColorGroup">
                        <label>Color:</label>
                        <input type="color" id="singleColor" value="#0078d4" />
                    </div>
                    <div class="form-group">
                        <label for="layerOpacitySlider">Opacity: <span id="opacityValue">100</span>%</label>
                        <input type="range" id="layerOpacitySlider" class="opacity-slider-wide" min="0" max="100" value="100">
                    </div>
                    <div class="form-group" id="showLabelsGroup" style="display: none;">
                        <label class="checkbox-label">
                            <input type="checkbox" id="showLabelsToggle">
                            <span>Show Polygon Names</span>
                        </label>
                    </div>
                    <div class="modal-actions">
                        <button id="applyStyleBtn" class="btn btn-primary">Apply Style</button>
                        <button id="cancelStyleBtn" class="btn btn-secondary">Cancel</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Plugins Modal -->
        <div id="pluginsModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Plugins</h2>
                    <span class="close" data-modal="pluginsModal">&times;</span>
                </div>
                <div class="modal-body">
                    <div id="pluginsList" class="plugins-list">
                        <!-- Plugins will be dynamically added here -->
                    </div>
                    <div id="noPluginsMessage" class="empty-state" style="display: none;">
                        <p>No plugins installed.</p>
                        <p class="text-muted">Add plugin files to the <code>plugins/</code> folder to extend functionality.</p>
                    </div>
                    <div class="plugins-stats" id="pluginsStats">
                        <!-- Stats will be added dynamically -->
                    </div>
                    <div class="modal-actions">
                        <button id="closePluginsBtn" class="btn btn-secondary">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Validation Results Modal -->
        <div id="validationModal" class="modal">
            <div class="modal-content modal-large">
                <div class="modal-header">
                    <h2>Data Validation Results</h2>
                    <span class="close" data-modal="validationModal">&times;</span>
                </div>
                <div class="modal-body">
                    <div id="validationSummary" class="validation-summary">
                        <!-- Summary will be inserted here -->
                    </div>

                    <div id="validationErrors" class="validation-errors" style="display: none;">
                        <h3>Validation Errors</h3>
                        <div id="errorList" class="error-list">
                            <!-- Error details will be inserted here -->
                        </div>
                    </div>

                    <div class="modal-actions">
                        <button id="importValidDataBtn" class="btn btn-primary" style="display: none;">Import Valid Rows</button>
                        <button id="downloadErrorsBtn" class="btn btn-secondary" style="display: none;">Download Error Report</button>
                        <button id="closeValidationBtn" class="btn btn-secondary">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
        <p>Loading...</p>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <!-- PapaParse for CSV parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <!-- SheetJS for Excel parsing -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <!-- Wellknown for WKT parsing -->
    <script src="https://unpkg.com/wellknown@0.5.0/wellknown.js"></script>

    <!-- Application JavaScript - New Modular Architecture -->
    <!-- Core modules (no dependencies) -->
    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>

    <!-- State and UI management (depends on utils) -->
    <script src="js/state-manager.js"></script>
    <script src="js/ui-components.js"></script>

    <!-- Services (depends on config, utils) -->
    <script src="js/validation-service.js"></script>
    <script src="js/data-services.js"></script>

    <!-- Plugin system (depends on state-manager, ui-components, utils, validation) -->
    <script src="js/plugin-api.js"></script>

    <!-- Example plugin (optional - can be removed or disabled) -->
    <script src="plugins/example-plugin.js"></script>

    <!-- Heat Map Overlay Plugin -->
    <script src="plugins/heatmap-overlay.js"></script>

    <!-- Existing application modules -->
    <script src="js/firebase-config.js"></script>
    <script src="js/geocoding-service.js"></script>
    <script src="js/csv-parser.js"></script>
    <script src="js/map-manager.js"></script>
    <script src="js/layer-manager.js"></script>

    <!-- Main application controller -->
    <script src="js/app.js"></script>

    <!-- Google Maps JavaScript API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCUdAbY7osfgatmss5tCYOgybqE1mzEwzA&libraries=places,marker,visualization&v=weekly&loading=async&callback=initMap"></script>

    <!-- MarkerClusterer for point clustering -->
    <script src="https://unpkg.com/@googlemaps/markerclusterer@2.5.3/dist/index.min.js"></script>
</body>
</html>
